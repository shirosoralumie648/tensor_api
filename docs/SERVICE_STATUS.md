# Oblivious 服务开发状态

本文档记录各个微服务的开发状态和实现情况。

**最后更新**: 2024 年 11 月 21 日  
**项目版本**: v0.3.0-alpha

---

## 服务状态概览

| 服务名称 | 状态 | 端口 | 进度 | 说明 |
|---------|------|------|------|------|
| **API Gateway** | ✅ 已实现 | 8080 | 90% | 核心功能完成，计费路由待启用 |
| **User Service** | ✅ 已实现 | 8081 | 85% | 基础功能完成，2FA 待实现 |
| **Chat Service** | ✅ 已实现 | 8082 | 80% | 核心对话功能完成，流式响应优化中 |
| **Relay Service** | ✅ 已实现 | 8083 | 75% | 支持 OpenAI，其他提供商适配中 |
| **Agent Service** | 🚧 开发中 | 8084 | 30% | 数据表已创建，API 实现中 |
| **Billing Service** | 🚧 开发中 | 8088 | 40% | 数据模型完成，计费逻辑实现中 |
| **RAG/KB Service** | 🚧 开发中 | 8085 | 20% | 数据表已创建，核心功能待实现 |
| **File Service** | 📋 规划中 | 8086 | 0% | 需求设计中 |
| **Plugin Service** | 📋 规划中 | 8087 | 0% | 需求设计中 |
| **Worker Service** | 📋 规划中 | 8089 | 0% | 异步任务处理，待设计 |

**图例**:
- ✅ 已实现：核心功能完成，可用于开发/测试
- 🚧 开发中：部分功能实现，正在积极开发
- 📋 规划中：已规划但尚未开始开发
- ❌ 已废弃：不再维护或已移除

---

## 详细状态

### ✅ API Gateway (网关服务)

**当前版本**: v0.3.0  
**开发状态**: 已实现核心功能

#### 已实现功能
- ✅ JWT 认证中间件
- ✅ 限流中间件（基于 Redis）
- ✅ CORS 处理
- ✅ 请求日志记录
- ✅ 请求 ID 追踪
- ✅ 路由转发（到用户、对话、中转服务）
- ✅ 健康检查端点
- ✅ SSE 流式响应代理

#### 待实现功能
- 🔲 熔断降级（Hystrix）
- 🔲 链路追踪（OpenTelemetry）
- 🔲 计费服务路由（当 Billing Service 就绪后启用）
- 🔲 Admin 管理接口路由

#### 技术栈
- Gin Web 框架
- Redis (限流)
- JWT (认证)
- Zap (日志)

#### 入口文件
- `/backend/cmd/gateway/main.go`

---

### ✅ User Service (用户服务)

**当前版本**: v0.2.5  
**开发状态**: 基础功能完成

#### 已实现功能
- ✅ 用户注册（用户名 + 邮箱 + 密码）
- ✅ 用户登录
- ✅ Token 刷新
- ✅ 获取用户信息
- ✅ 更新用户信息
- ✅ 密码加密（bcrypt）
- ✅ 用户设置管理

#### 待实现功能
- 🔲 邮箱验证
- 🔲 忘记密码/重置密码
- 🔲 2FA 双因素认证
- 🔲 OAuth 第三方登录
- 🔲 用户邀请系统
- 🔲 额度充值接口

#### 数据库表
- `users` - 用户基础信息
- `user_settings` - 用户设置
- `quota_logs` - 额度变动日志

#### 入口文件
- `/backend/cmd/user/main.go`

---

### ✅ Chat Service (对话服务)

**当前版本**: v0.2.5  
**开发状态**: 核心功能完成

#### 已实现功能
- ✅ 创建对话会话
- ✅ 获取会话列表
- ✅ 获取会话详情
- ✅ 更新会话信息
- ✅ 删除会话（软删除）
- ✅ 发送消息（非流式）
- ✅ 发送消息（流式 SSE）
- ✅ 获取消息历史
- ✅ 调用 Relay Service 获取 AI 响应

#### 待实现功能
- 🔲 会话分组管理
- 🔲 话题（Topic）管理
- 🔲 消息编辑/删除
- 🔲 消息搜索
- 🔲 上下文窗口管理优化
- 🔲 消息导出功能
- 🔲 流式响应性能优化

#### 数据库表
- `sessions` - 对话会话
- `messages` - 消息记录
- `topics` - 话题（尚未使用）

#### 入口文件
- `/backend/cmd/chat/main.go`

---

### ✅ Relay Service (中转服务)

**当前版本**: v0.2.0  
**开发状态**: 基础实现完成

#### 已实现功能
- ✅ OpenAI API 适配器
- ✅ 渠道管理（Channel）
- ✅ 简单的渠道选择逻辑
- ✅ 非流式对话
- ✅ 流式对话（SSE）
- ✅ 模型列表查询
- ✅ Token 计数
- ✅ 错误处理和重试

#### 待实现功能
- 🔲 Claude (Anthropic) 适配器
- 🔲 Gemini (Google) 适配器
- 🔲 Azure OpenAI 适配器
- 🔲 国产大模型适配器（文心一言、通义千问等）
- 🔲 智能渠道选择（负载均衡、成本优化）
- 🔲 渠道健康检查
- 🔲 渠道切换和故障转移
- 🔲 调用统计和分析

#### 数据库表
- `channels` - 渠道配置

#### 入口文件
- `/backend/cmd/relay/main.go`

---

### 🚧 Agent Service (助手服务)

**当前版本**: v0.1.0  
**开发状态**: 数据模型完成，API 开发中

#### 已实现功能
- ✅ 数据库表结构设计
- ✅ 助手数据模型

#### 待实现功能
- 🔲 创建助手
- 🔲 获取用户助手列表
- 🔲 获取助手详情
- 🔲 更新助手配置
- 🔲 删除助手
- 🔲 助手市场（公开助手浏览）
- 🔲 助手分类和标签
- 🔲 助手搜索
- 🔲 助手点赞和收藏
- 🔲 助手统计信息

#### 数据库表
- `agents` - 助手信息
- `agent_tags` - 标签
- `agent_tag_relations` - 助手标签关系

#### 入口文件
- `/backend/cmd/agent/main.go` (空文件)

---

### 🚧 Billing Service (计费服务)

**当前版本**: v0.1.5  
**开发状态**: 数据模型完成，业务逻辑开发中

#### 已实现功能
- ✅ 完整的数据库表结构
- ✅ 订阅计划模型
- ✅ 计费记录模型
- ✅ 优惠券系统模型
- ✅ 发票系统模型

#### 待实现功能
- 🔲 Token 使用量记录
- 🔲 实时成本计算
- 🔲 订阅计划管理
- 🔲 自动扣费逻辑
- 🔲 优惠券应用
- 🔲 发票生成
- 🔲 账单查询
- 🔲 额度告警
- 🔲 支付网关集成（Stripe/PayPal）
- 🔲 充值接口

#### 数据库表
- `subscription_plans` - 订阅计划
- `subscriptions` - 用户订阅
- `billing_records` - 计费记录
- `invoices` - 发票
- `coupons` - 优惠券
- `coupon_usage` - 优惠券使用记录
- `billing_settings` - 用户计费设置

#### 入口文件
- `/backend/cmd/billing/main.go` (空文件)

---

### 🚧 RAG/KB Service (知识库服务)

**当前版本**: v0.1.0  
**开发状态**: 数据模型完成，功能开发中

#### 已实现功能
- ✅ 数据库表结构设计
- ✅ pgvector 扩展集成

#### 待实现功能
- 🔲 创建知识库
- 🔲 文档上传
- 🔲 文档解析（PDF、Word、Markdown 等）
- 🔲 文本分块（Chunking）
- 🔲 向量化（Embedding）
- 🔲 向量存储和索引
- 🔲 语义检索
- 🔲 RAG 对话集成
- 🔲 知识库管理
- 🔲 文档管理

#### 数据库表
- `knowledge_bases` - 知识库
- `documents` - 文档
- `chunks` - 文档片段（含向量）

#### 入口文件
- `/backend/cmd/kb/main.go` 或 `/backend/cmd/rag/main.go` (空文件)

---

### 📋 File Service (文件服务)

**当前版本**: v0.0.0  
**开发状态**: 规划中

#### 计划功能
- 文件上传（用户头像、对话图片、文档）
- 文件存储（MinIO/S3）
- 文件访问授权
- 临时 URL 签名
- 文件去重（基于哈希）
- 文件类型检测和验证
- 图片处理（缩略图、压缩）
- 文件管理（列表、删除）

#### 预计完成时间
- 2024 年 12 月

---

### 📋 Plugin Service (插件服务)

**当前版本**: v0.0.0  
**开发状态**: 规划中

#### 计划功能
- 插件市场
- 插件安装和配置
- 插件调用代理
- 插件安全沙箱
- 内置插件（联网搜索、天气查询等）
- 第三方插件支持
- 插件开发文档

#### 预计完成时间
- 2025 年 1 月

---

### 📋 Worker Service (异步任务服务)

**当前版本**: v0.0.0  
**开发状态**: 规划中

#### 计划功能
- 异步任务队列（基于 RabbitMQ）
- 定时任务（Cron）
- 文档处理任务
- 邮件发送任务
- 报表生成任务
- 数据清理任务
- 任务监控和重试

#### 预计完成时间
- 2025 年 1 月

---

## 基础设施

### 数据库（PostgreSQL）

**状态**: ✅ 生产就绪

- 9 个迁移文件已创建
- 核心表结构完整
- 支持软删除
- 索引已优化

### 缓存（Redis）

**状态**: ✅ 部分实现

- Gateway 限流使用中
- Session 缓存计划中
- 热点数据缓存待实现

### 消息队列（RabbitMQ）

**状态**: 📋 规划中

- Docker 配置已准备
- 待集成到 Worker Service

### 对象存储（MinIO）

**状态**: 🚧 配置中

- Docker 配置已准备
- 待集成到 File Service

### 监控系统

**状态**: 🚧 部分实现

- Prometheus 配置准备中
- Grafana 仪表盘设计中
- Loki 日志系统规划中

---

## 前端应用

### Web 前端

**状态**: ✅ 基础实现

**已实现**:
- ✅ 基础页面结构
- ✅ 登录/注册页面
- ✅ 对话界面
- ✅ API 客户端封装

**待实现**:
- 🔲 完整的 UI 组件库集成
- 🔲 助手市场
- 🔲 知识库管理
- 🔲 用户设置页面
- 🔲 计费和订阅页面
- 🔲 暗色模式
- 🔲 国际化（i18n）

---

## 开发路线图

### 当前阶段 (v0.3.x) - 核心功能完善

**目标**: 完善已实现服务的功能

- 优化 Chat Service 流式响应
- 增强 Relay Service 错误处理
- User Service 添加邮箱验证
- Gateway 增加链路追踪

### 下一阶段 (v0.4.x) - 扩展服务开发

**目标**: 实现 Agent 和 Billing 服务

- 完成 Agent Service 核心功能
- 完成 Billing Service 计费逻辑
- 集成支付网关
- 前端增加助手和计费页面

### 未来阶段 (v0.5.x+) - 高级功能

**目标**: 知识库、插件、文件服务

- 实现 RAG/KB Service
- 实现 File Service
- 实现 Plugin Service
- Worker Service 异步任务
- 移动端应用

---

## 技术债务

当前需要关注的技术债务：

1. **测试覆盖率不足**: 
   - 当前覆盖率约 40%
   - 目标提升到 80%

2. **错误处理不统一**:
   - 需要统一错误码和错误消息格式

3. **日志规范不一致**:
   - 需要制定统一的日志规范

4. **性能优化**:
   - 数据库查询优化
   - 缓存策略优化
   - 流式响应性能优化

5. **文档完善**:
   - API 文档需要持续更新
   - 部署文档需要更详细

---

## 如何贡献

如果您想参与某个服务的开发：

1. 查看该服务的待实现功能列表
2. 在 GitHub Issues 中认领任务或创建新任务
3. Fork 仓库并创建特性分支
4. 参考 [贡献指南](CONTRIBUTING.md) 开发
5. 提交 Pull Request

---

**文档版本**: v1.0.0  
**最后更新**: 2024 年 11 月 21 日  
**维护团队**: Oblivious 开发团队
