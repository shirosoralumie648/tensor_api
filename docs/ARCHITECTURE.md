# Oblivious 架构设计

## 概述

Oblivious 是一个面向 C 端用户的 AI 应用服务平台，采用微服务架构设计，支持云原生部署和水平扩展。系统同时保留 B 端 API 中转能力，为开发者提供统一的 AI 接口。

## 设计原则

- **服务解耦**：各服务独立开发、部署、扩容
- **高可用**：支持多实例部署和故障自动转移
- **高性能**：Go 语言构建，支持万级 QPS
- **可扩展**：模块化设计，易于添加新功能
- **安全可靠**：多层安全防护，完整的日志追踪

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                         客户端层                              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │  浏览器  │  │  桌面端  │  │  移动端  │  │ API调用  │   │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘   │
└───────┼─────────────┼─────────────┼─────────────┼──────────┘
        │             │             │             │
        └─────────────┴─────────────┴─────────────┘
                          │ HTTPS
        ┌─────────────────▼─────────────────┐
        │        前端服务 (Next.js)          │
        │    - 静态资源服务                  │
        │    - SEO 优化                     │
        │    - 客户端路由                   │
        └─────────────────┬─────────────────┘
                          │
        ┌─────────────────▼─────────────────┐
        │         API 网关 (Gateway)         │
        │    - 统一入口                      │
        │    - JWT 认证                     │
        │    - 限流熔断                      │
        │    - 路由转发                      │
        └─────────────────┬─────────────────┘
                          │
    ┌────────────┬────────┼────────┬─────────┬─────────┐
    │            │        │        │         │         │
    ▼            ▼        ▼        ▼         ▼         ▼
┌────────┐  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐
│ 用户   │  │ 对话   │ │ 中转   │ │ 助手   │ │ 知识库 │ │ 计费   │
│ 服务   │  │ 服务   │ │ 服务   │ │ 服务   │ │ 服务   │ │ 服务   │
└───┬────┘  └───┬────┘ └───┬────┘ └───┬────┘ └───┬────┘ └───┬────┘
    │           │          │          │          │          │
    └───────────┴──────────┴──────────┴──────────┴──────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
        ▼                 ▼                 ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│  PostgreSQL  │  │  Redis       │  │  RabbitMQ    │
│  (主数据库)   │  │  (缓存)       │  │  (消息队列)   │
└──────────────┘  └──────────────┘  └──────────────┘
        │
        ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│   pgvector   │  │   MinIO      │  │   上游AI     │
│  (向量检索)   │  │  (对象存储)   │  │  (OpenAI等)  │
└──────────────┘  └──────────────┘  └──────────────┘
```

## 核心服务

### 1. API 网关服务 (Gateway)

**职责**：
- 作为所有请求的统一入口
- JWT 认证和用户身份验证
- 请求限流和熔断保护
- 路由分发到各微服务
- 日志记录和链路追踪

**技术栈**：
- Gin Web 框架
- JWT 认证中间件
- Rate Limiter 限流器

**关键文件**：
- `backend/cmd/gateway/main.go` - 服务启动入口
- `backend/internal/gateway/handler/proxy.go` - 请求代理逻辑
- `backend/internal/middleware/auth.go` - 认证中间件

### 2. 用户服务 (User)

**职责**：
- 用户注册、登录、注销
- JWT Token 生成和验证
- 用户信息管理
- 额度查询和充值记录

**数据模型**：
- `users` - 用户基本信息表
- `user_settings` - 用户设置表

**关键文件**：
- `backend/cmd/user/main.go` - 服务启动
- `backend/internal/model/user.go` - 用户模型
- `backend/migrations/000001_create_users_table.up.sql` - 数据库迁移

### 3. 对话服务 (Chat)

**职责**：
- 处理 AI 对话请求
- 管理会话和消息历史
- 调用 Relay 服务进行 AI 中转
- 流式响应处理

**数据模型**：
- `sessions` - 对话会话表
- `messages` - 消息记录表

**关键文件**：
- `backend/cmd/chat/main.go` - 服务启动
- `backend/internal/chat/handler/completion.go` - 对话处理
- `backend/internal/model/session.go` - 会话模型

### 4. 中转服务 (Relay)

**职责**：
- 对接多家上游 AI 提供商
- 渠道选择和负载均衡
- 请求格式转换（适配器模式）
- 流式响应转发
- 错误处理和重试

**支持的提供商**：
- OpenAI (GPT-3.5/GPT-4)
- Anthropic (Claude)
- Google (Gemini)
- 国内大模型（通义千问、文心一言等）

**关键文件**：
- `backend/cmd/relay/main.go` - 服务启动
- `backend/internal/relay/service/dispatcher.go` - 渠道调度器
- `backend/internal/adapter/openai/client.go` - OpenAI 适配器
- `new-api-main/relay/channel/` - 渠道适配器集合

### 5. 计费服务 (Billing)

**职责**：
- 用户额度检查
- 实时扣费
- 账单记录（异步）
- 消费统计

**工作流程**：
1. 请求前：检查用户额度是否充足
2. 请求中：预扣费或锁定额度
3. 请求后：根据实际消耗扣费
4. 异步：通过 MQ 记录详细账单

**关键文件**：
- `backend/cmd/billing/main.go` - 服务启动
- `backend/internal/billing/service/deduct.go` - 扣费逻辑
- `backend/internal/billing/consumer/recorder.go` - 账单记录消费者

### 6. 知识库服务 (Knowledge)

**职责**：
- 文档上传和管理
- 文本提取和分块
- 向量化（Embedding）
- 基于 pgvector 的语义检索

**RAG 流程**：
1. 文档上传到 MinIO
2. 提取文本内容
3. 文本分块（chunk + overlap）
4. 调用 OpenAI API 生成向量
5. 存储到 pgvector
6. 查询时进行余弦相似度检索

**关键文件**：
- `backend/cmd/knowledge/main.go` - 服务启动
- `backend/internal/knowledge/service/processor.go` - 文档处理
- `backend/internal/rag/embedding.go` - 向量化
- `backend/internal/knowledge/repository/vector.go` - 向量检索

### 7. 文件服务 (File)

**职责**：
- 文件上传和下载
- 与 MinIO 对象存储交互
- 文件元数据管理

### 8. 助手服务 (Agent)

**职责**：
- AI 助手模板管理
- 助手市场
- 用户自定义助手

### 9. 插件服务 (Plugin)

**职责**：
- 插件注册和管理
- 插件调用（联网搜索、代码执行等）
- 插件市场

## 数据流转

### 典型对话请求流程

```
1. 用户发送对话请求
   └─> 前端 (Next.js)
       └─> API 网关 (Gateway)
           ├─> JWT 认证中间件验证
           ├─> 限流检查
           └─> 路由到对话服务

2. 对话服务处理
   └─> Chat Service
       ├─> 从上下文提取用户 ID
       ├─> 创建/获取会话记录
       ├─> 调用计费服务检查额度
       └─> 调用中转服务

3. 中转服务处理
   └─> Relay Service
       ├─> 选择最优上游渠道
       ├─> 适配器转换请求格式
       ├─> 调用上游 AI API
       └─> 流式响应处理

4. 响应返回
   └─> Relay → Chat → Gateway → 前端
       └─> SSE 实时推送到客户端

5. 计费处理（异步）
   └─> Billing Service
       ├─> 根据实际消耗扣费
       └─> 发送 MQ 消息记录账单
```

## 技术选型说明

### 为什么选择 Go

- **高性能**：原生支持并发，适合高并发场景
- **简洁高效**：语法简单，开发效率高
- **云原生**：K8s、Docker 等云原生工具都用 Go 编写
- **丰富生态**：Web、数据库、消息队列等库完善

### 为什么选择微服务

- **独立扩容**：高负载服务可以单独扩展实例
- **技术异构**：不同服务可以使用不同技术栈
- **故障隔离**：单个服务故障不影响整体
- **团队协作**：不同团队可以并行开发

### 为什么选择 PostgreSQL

- **功能强大**：支持 JSON、全文检索、事务
- **pgvector 扩展**：原生支持向量检索
- **成熟稳定**：久经考验的企业级数据库
- **开源免费**：无商业许可限制

## 可扩展性设计

### 水平扩展

- **无状态服务**：所有微服务设计为无状态，可任意扩展实例
- **负载均衡**：Kubernetes Service 自动负载均衡
- **数据库连接池**：避免数据库连接数过多

### 垂直扩展

- **资源配额**：K8s 可以动态调整 CPU/内存配额
- **数据库优化**：索引、分区表、读写分离

## 高可用设计

### 服务层

- **多实例部署**：关键服务部署多个副本
- **健康检查**：K8s liveness/readiness probe
- **自动重启**：服务崩溃自动重启
- **熔断降级**：防止级联故障

### 数据层

- **PostgreSQL 主从复制**：读写分离
- **Redis Cluster**：高可用集群模式
- **MinIO 集群**：分布式对象存储
- **定期备份**：数据库定期备份到 S3

## 安全设计

### 认证授权

- **JWT Token**：无状态身份验证
- **Token 刷新**：Access Token + Refresh Token
- **权限控制**：基于角色的访问控制 (RBAC)

### 数据安全

- **密码加密**：bcrypt 哈希
- **敏感信息加密**：AES-256
- **HTTPS**：所有外部通信使用 TLS
- **SQL 注入防护**：ORM 参数化查询

### 限流防护

- **IP 限流**：防止恶意攻击
- **用户限流**：防止滥用
- **令牌桶算法**：平滑限流

## 监控告警

### 指标监控

- **Prometheus**：收集服务指标
- **Grafana**：可视化监控面板
- **关键指标**：
  - QPS、延迟、错误率
  - 服务健康状态
  - 数据库连接数
  - 缓存命中率

### 日志系统

- **Loki**：日志聚合
- **结构化日志**：JSON 格式
- **日志级别**：DEBUG/INFO/WARN/ERROR

### 链路追踪

- **OpenTelemetry**：分布式追踪
- **Jaeger**：链路可视化
- **跨服务追踪**：追踪请求完整路径

## 性能优化

### 缓存策略

- **用户信息缓存**：减少数据库查询
- **额度缓存**：高频读取场景
- **会话缓存**：减少会话查询

### 异步处理

- **账单记录**：通过 MQ 异步写入
- **数据统计**：离线计算
- **邮件通知**：异步发送

### 数据库优化

- **索引优化**：常用查询字段建立索引
- **分页查询**：避免一次性加载大量数据
- **连接池**：复用数据库连接

## 未来规划

### 短期规划

- [ ] 完善助手市场功能
- [ ] 增加更多 AI 提供商支持
- [ ] 实现插件系统
- [ ] 移动端应用

### 长期规划

- [ ] 支持私有化部署
- [ ] 多租户 SaaS 模式
- [ ] AI 模型微调平台
- [ ] 企业级权限管理

## 相关文档

- [API 网关设计](API_GATEWAY_DESIGN.md)
- [数据库设计](DATABASE_DESIGN.md)
- [项目结构](PROJECT_STRUCTURE.md)
- [API 参考](API_REFERENCE.md)
